<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIN ISO 2768 – General Tolerance Calculator</title>
<style>
  :root{
    /* Dark theme (default) */
    --bg:#0b0f14; --panel:#0f1621; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --border:#1f2937; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  /* Light CAD-style theme */
  :root[data-theme="light"]{
    --bg:#f4f6f8;            /* light gray CAD-style */
    --panel:#ffffff;
    --card:#ffffff;
    --text:#1a1a1a;
    --muted:#5f6b7a;
    --border:#d9e1ea;
    --accent:#4a90e2;        /* soft CAD blue */
    --ok:#2eb872;
    --warn:#d39a00;
    --bad:#d64545;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    transition: background-color .3s ease, color .3s ease;
  }
  header{
    position:sticky;top:0;z-index:10;
    background:color-mix(in oklab, var(--bg) 92%, transparent);
    backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border);
    padding:16px 12px;
    transition: background-color .3s ease, border-color .3s ease;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 6px 0;font-size:20px}
  .sub{margin:0;color:var(--muted);font-size:13px}
  .topbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .group{display:flex;gap:8px;align-items:center;background:var(--panel);padding:8px;border:1px solid var(--border);border-radius:12px;transition: background-color .3s ease, border-color .3s ease}
  .lang button,.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition: background-color .3s ease, border-color .3s ease, color .3s ease}
  .lang button.active{outline:2px solid var(--ok)}
  main .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px;transition: background-color .3s ease, border-color .3s ease}
  label{font-size:13px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:color-mix(in oklab, var(--bg) 92%, #ffffff 8%);color:var(--text);transition: background-color .3s ease, border-color .3s ease, color .3s ease}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
  .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition: background-color .3s ease, border-color .3s ease, color .3s ease}
  .btn.primary{background:var(--accent);border-color:color-mix(in oklab, var(--accent) 70%, #000 30%);color:#ffffff;font-weight:600}
  .muted{color:var(--muted)}
  .result{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .badge{font-size:12px;color:#0b0f14;background:var(--ok);padding:4px 8px;border-radius:8px;font-weight:700;display:inline-block}
  .warn{background:var(--warn)}
  .bad{background:var(--bad)}
  code,pre{background:color-mix(in oklab, var(--bg) 90%, #ffffff 10%);border:1px solid var(--border);border-radius:10px;padding:8px;color:inherit;transition: background-color .3s ease, border-color .3s ease}
  details{border:1px dashed var(--border);border-radius:10px;padding:10px}
  .rtl{direction:rtl}
  .hidden{display:none}

  footer{
    padding:16px 12px;border-top:1px solid var(--border);color:var(--muted);
    transition: background-color .3s ease, border-color .3s ease, color .3s ease
  }
  .footer-row{
    max-width:1100px;margin:0 auto;padding:0 16px;
    display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap;
  }
  .theme-chip{
    display:flex;align-items:center;gap:8px;
    background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:999px;
    transition: background-color .3s ease, border-color .3s ease, color .3s ease
  }
  .theme-btn{cursor:pointer;border:none;background:transparent;font-size:16px;line-height:1}
  .yt-link{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--text);}
  .yt-icon{width:18px;height:18px;display:inline-block}
  .dev{color:var(--text)}
  .sep{color:var(--muted)}
  a{color:var(--accent)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  thead th{position:sticky;top:0;background:color-mix(in oklab, var(--bg) 92%, #ffffff 8%)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 data-i18n="title">DIN ISO 2768 – General Tolerance Calculator</h1>
    <p class="sub" data-i18n="subtitle">Enter nominal size / angle, pick the tolerance class, and get the ± deviations. English is default.</p>
    <div class="topbar">
      <div class="group lang">
        <strong class="muted" data-i18n="language">Language</strong>
        <button data-lang="en" class="active">English</button>
        <button data-lang="de">Deutsch</button>
        <button data-lang="ar">العربية</button>
      </div>
      <div class="group">
        <span class="muted" data-i18n="mode">Mode</span>
        <button class="pill" data-mode="linear">Linear</button>
        <button class="pill" data-mode="angular">Angular</button>
        <button class="pill" data-mode="chamfer">Chamfer / Radius</button>
        <button class="pill" data-mode="geom">Geometrical (ISO 2768-2)</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Inputs -->
  <div class="card">
    <div id="section-linear" class="mode-section">
      <h3 data-i18n="linear_title">Linear dimensions (DIN ISO 2768-1)</h3>
      <div class="grid">
        <div class="col-4">
          <label data-i18n="nominal_mm">Nominal size (mm)</label>
          <input id="lin-n" type="number" min="0" step="0.001" placeholder="e.g. 42.5">
        </div>
        <div class="col-4">
          <label data-i18n="class">Tolerance class</label>
          <select id="lin-class">
            <option value="f">f — fine</option>
            <option value="m" selected>m — medium</option>
            <option value="c">c — coarse</option>
            <option value="v">v — very coarse</option>
          </select>
        </div>
        <div class="col-4">
          <button id="lin-calc" class="btn primary" data-i18n="calculate">Calculate</button>
        </div>
        <div class="col-12 muted" data-i18n="linear_hint">Tolerance values are ± symmetric per ISO 2768‑1 Table for linear dimensions.</div>
      </div>
      <div id="lin-out" class="result hidden"></div>
    </div>

    <div id="section-angular" class="mode-section hidden">
      <h3 data-i18n="angular_title">Angular dimensions (DIN ISO 2768-1)</h3>
      <div class="grid">
        <div class="col-4">
          <label data-i18n="shorter_side_mm">Relevant length (shorter side) L (mm)</label>
          <input id="ang-l" type="number" min="0" step="0.1" placeholder="e.g. 80">
        </div>
        <div class="col-4">
          <label data-i18n="angle_deg">Nominal angle (deg)</label>
          <input id="ang-a" type="number" step="0.01" placeholder="e.g. 90">
        </div>
        <div class="col-4">
          <label data-i18n="class">Tolerance class</label>
          <select id="ang-class">
            <option value="f">f — fine</option>
            <option value="m" selected>m — medium</option>
            <option value="c">c — coarse</option>
            <option value="v">v — very coarse</option>
          </select>
        </div>
        <div class="col-12">
          <button id="ang-calc" class="btn primary" data-i18n="calculate">Calculate</button>
        </div>
        <div class="col-12 muted" data-i18n="angular_hint">
          Angular tolerance depends on the shorter side length L per ISO 2768‑1. Output is ± in degrees and arcminutes.
        </div>
      </div>
      <div id="ang-out" class="result hidden"></div>
    </div>

    <div id="section-chamfer" class="mode-section hidden">
      <h3 data-i18n="chamfer_title">Chamfers & Radii (DIN ISO 2768-1)</h3>
      <div class="grid">
        <div class="col-4">
          <label data-i18n="feature_size_mm">Feature size (mm)</label>
          <input id="chf-s" type="number" min="0" step="0.01" placeholder="e.g. 2 (for C2 / R2)">
        </div>
        <div class="col-4">
          <label data-i18n="class">Tolerance class</label>
          <select id="chf-class">
            <option value="f">f — fine</option>
            <option value="m" selected>m — medium</option>
            <option value="c">c — coarse</option>
            <option value="v">v — very coarse</option>
          </select>
        </div>
        <div class="col-4">
          <button id="chf-calc" class="btn primary" data-i18n="calculate">Calculate</button>
        </div>
        <div class="col-12 muted" data-i18n="chamfer_hint">
          For chamfers (C) and radii (R), tolerances are ± according to ISO 2768‑1 table.
        </div>
      </div>
      <div id="chf-out" class="result hidden"></div>
    </div>

    <div id="section-geom" class="mode-section hidden">
      <h3 data-i18n="geom_title">Geometrical tolerances (DIN ISO 2768-2)</h3>
      <div class="grid">
        <div class="col-3">
          <label data-i18n="feature_len_mm">Feature length (mm)</label>
          <input id="geo-l" type="number" min="0" step="0.1" placeholder="e.g. 200">
        </div>
        <div class="col-3">
          <label data-i18n="geo_feature">Feature</label>
          <select id="geo-feature">
            <option value="straightness">Straightness</option>
            <option value="flatness">Flatness</option>
            <option value="circularity">Circularity</option>
            <option value="parallelism">Parallelism</option>
            <option value="perpendicularity">Perpendicularity</option>
            <option value="symmetry">Symmetry</option>
            <option value="runout">Radial run-out</option>
          </select>
        </div>
        <div class="col-3">
          <label data-i18n="geo_class">Class (ISO 2768-2)</label>
          <select id="geo-class">
            <option value="H" selected>H</option>
            <option value="K">K</option>
            <option value="L">L</option>
          </select>
        </div>
        <div class="col-3">
          <button id="geo-calc" class="btn primary" data-i18n="calculate">Calculate</button>
        </div>
        <div class="col-12 muted" data-i18n="geom_hint">
          Values follow ISO 2768‑2 general geometrical tolerances by feature and length. Verify against your standard.
        </div>
      </div>
      <div id="geo-out" class="result hidden"></div>
    </div>
  </div>

  <!-- Data panel -->
  <div class="card">
    <details>
      <summary><strong data-i18n="data_title">Reference data (click to view)</strong></summary>
      <p class="muted" data-i18n="data_note">
        Linear data matches common ISO 2768‑1 tables. Angular/chamfer/geometrical sets are provided as a practical reference;
        please verify exact values against your company standard or the official norm and adjust here if needed.
      </p>
      <div id="data-view"></div>
    </details>
  </div>
</main>

<footer>
  <div class="footer-row">
    <span class="theme-chip">
      <button id="theme-toggle" class="theme-btn" aria-label="Toggle theme">☀️/🌙</button>
      <span id="theme-status" data-i18n-theme="dark">Dark mode</span>
    </span>
    <span class="sep">|</span>
    <span class="dev" data-i18n="developed_by">Developed by Engineer Zaher Taleb</span>
    <span class="sep">|</span>
    <a class="yt-link" href="https://www.youtube.com/@Zaher.Taleb.mechanical.design" target="_blank" rel="noopener">
      <svg class="yt-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#FF0000" d="M23.5 6.2s-.2-1.6-.8-2.3c-.8-.8-1.6-.8-2-0.9C17.6 2.5 12 2.5 12 2.5h0s-5.6 0-8.7.4c-.5.1-1.2.1-2 .9C.7 4.6.5 6.2.5 6.2S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.6.8 2.3c.8.8 1.8.8 2.3.9 1.7.2 7.4.4 8.4.4h.1c1 0 6.7-.1 8.4-.4.5-.1 1.5-.1 2.3-.9.6-.6.8-2.3.8-2.3s.5-1.9.5-3.8V10c0-1.9-.5-3.8-.5-3.8z"/>
        <path fill="#fff" d="M9.8 15.3V7.9l6.4 3.7-6.4 3.7z"/>
      </svg>
      <span data-i18n="youtube_channel">YouTube Channel</span>
    </a>
  </div>
</footer>

<script>
// ---------------- Language packs ----------------
const I18N = {
  en: {
    title: "DIN ISO 2768 – General Tolerance Calculator",
    subtitle: "Enter nominal size / angle, pick the tolerance class, and get the ± deviations. English is default.",
    language: "Language",
    mode: "Mode",
    calculate: "Calculate",
    class: "Tolerance class",
    nominal_mm: "Nominal size (mm)",
    linear_title: "Linear dimensions (DIN ISO 2768-1)",
    linear_hint: "Tolerance values are ± symmetric per ISO 2768‑1 Table for linear dimensions.",
    angular_title: "Angular dimensions (DIN ISO 2768-1)",
    shorter_side_mm: "Relevant length (shorter side) L (mm)",
    angle_deg: "Nominal angle (deg)",
    angular_hint: "Angular tolerance depends on the shorter side length L per ISO 2768‑1. Output is ± in degrees and arcminutes.",
    chamfer_title: "Chamfers & Radii (DIN ISO 2768-1)",
    feature_size_mm: "Feature size (mm)",
    chamfer_hint: "For chamfers (C) and radii (R), tolerances are ± according to ISO 2768‑1 table.",
    geom_title: "Geometrical tolerances (DIN ISO 2768-2)",
    feature_len_mm: "Feature length (mm)",
    geo_feature: "Feature",
    geo_class: "Class (ISO 2768-2)",
    geom_hint: "Values follow ISO 2768‑2 general geometrical tolerances by feature and length. Verify against your standard.",
    data_title: "Reference data (click to view)",
    data_note: "Linear data matches common ISO 2768‑1 tables. Angular/chamfer/geometrical sets are provided as a practical reference; please verify exact values against your company standard or the official norm and adjust here if needed.",
    result: "Result",
    upper: "Upper deviation (+)",
    lower: "Lower deviation (−)",
    total: "Total tolerance",
    not_found: "No matching range for the given input.",
    developed_by: "Developed by Engineer Zaher Taleb",
    youtube_channel: "YouTube Channel",
    theme_dark: "Dark mode",
    theme_light: "Light mode"
  },
  de: {
    title: "DIN ISO 2768 – Allgemeintoleranz-Rechner",
    subtitle: "Nennmaß / Winkel eingeben, Toleranzklasse wählen und ± Abweichungen erhalten. Englisch ist Standard.",
    language: "Sprache",
    mode: "Modus",
    calculate: "Berechnen",
    class: "Toleranzklasse",
    nominal_mm: "Nennmaß (mm)",
    linear_title: "Längenmaße (DIN ISO 2768-1)",
    linear_hint: "Toleranzen sind ± symmetrisch gemäß ISO 2768‑1 Tabelle (Längenmaße).",
    angular_title: "Winkelmaße (DIN ISO 2768-1)",
    shorter_side_mm: "Bezugsmaß (kürzere Seite) L (mm)",
    angle_deg: "Sollwinkel (Grad)",
    angular_hint: "Winkeltoleranz hängt vom Bezugsmaß L ab (ISO 2768‑1). Ausgabe in ± Grad und Bogenminuten.",
    chamfer_title: "Gebrochene Kanten & Radien (DIN ISO 2768-1)",
    feature_size_mm: "Merkmalsgröße (mm)",
    chamfer_hint: "Für Fasen (C) und Radien (R) gelten ± Toleranzen gemäß ISO 2768‑1 Tabelle.",
    geom_title: "Geometrische Toleranzen (DIN ISO 2768-2)",
    feature_len_mm: "Merkmalslänge (mm)",
    geo_feature: "Merkmal",
    geo_class: "Klasse (ISO 2768-2)",
    geom_hint: "Werte gemäß ISO 2768‑2 (Form- und Lagetoleranzen) je nach Merkmal und Länge. Bitte prüfen.",
    data_title: "Referenzdaten (zum Anzeigen klicken)",
    data_note: "Lineardaten entsprechen gängigen ISO 2768‑1 Tabellen. Winkel/Fase/Geometrie sind praxisnah; bitte gegen Norm prüfen und ggf. anpassen.",
    result: "Ergebnis",
    upper: "Obere Abweichung (+)",
    lower: "Untere Abweichung (−)",
    total: "Gesamttoleranz",
    not_found: "Für die Eingabe wurde kein passender Bereich gefunden.",
    developed_by: "Developed by Engineer Zaher Taleb",
    youtube_channel: "YouTube-Kanal",
    theme_dark: "Dunkles Thema",
    theme_light: "Helles Thema"
  },
  ar: {
    title: "حاسبة السماحات – DIN ISO 2768",
    subtitle: "أدخل المقاس/الزاوية واختر فئة التسامح لتحصل على الانحرافات ±. الإنجليزية هي الافتراضية.",
    language: "اللغة",
    mode: "الوضع",
    calculate: "احسب",
    class: "فئة التسامح",
    nominal_mm: "المقاس الاسمي (مم)",
    linear_title: "الأبعاد الخطية (DIN ISO 2768-1)",
    linear_hint: "القيم ± متماثلة حسب جدول ISO 2768‑1 للأبعاد الخطية.",
    angular_title: "الأبعاد الزاويّة (DIN ISO 2768-1)",
    shorter_side_mm: "الطول المرجعي (الضلع الأقصر) L (مم)",
    angle_deg: "الزاوية الاسمية (درجة)",
    angular_hint: "تسامح الزاوية يعتمد على الطول المرجعي L حسب ISO 2768‑1. الإخراج ± بالدرجات والدقائق.",
    chamfer_title: "الحواف المكسورة والأنصاف أقطار (DIN ISO 2768-1)",
    feature_size_mm: "حجم المعلَم (مم)",
    chamfer_hint: "بالنسبة للفَسَح (C) وأنصاف الأقطار (R) تكون التسامحات ± حسب جدول ISO 2768‑1.",
    geom_title: "التسامحات الهندسية (DIN ISO 2768-2)",
    feature_len_mm: "طول المعلَم (مم)",
    geo_feature: "المعلَم",
    geo_class: "الفئة (ISO 2768-2)",
    geom_hint: "القيم وفق ISO 2768‑2 حسب المعلَم والطول. يُفضَّل التأكد من القيم.",
    data_title: "بيانات مرجعية (انقر للعرض)",
    data_note: "بيانات الأبعاد الخطية مطابقة للجداول الشائعة لـ ISO 2768-1. مجموعات الزاوية/الفَسْح/الهندسية عملية؛ يُستحسن التحقق من القيم وتعديلها هنا إن لزم.",
    result: "النتيجة",
    upper: "الانحراف الأعلى (+)",
    lower: "الانحراف الأدنى (−)",
    total: "إجمالي التسامح",
    not_found: "لا يوجد مجال مطابق للمدخلات.",
    developed_by: "تم التطوير بواسطة المهندس زاهر طالب",
    youtube_channel: "قناة يوتيوب",
    theme_dark: "الوضع الداكن",
    theme_light: "الوضع الفاتح"
  }
};

// ------------- Reference data (verify vs. your norm) -------------
// Linear (ISO 2768-1) — common table (± values in mm)
const DATA_LINEAR = [
  {range:[0,3],   f:0.05, m:0.1, c:0.2, v:0.5},
  {range:[3,6],   f:0.05, m:0.1, c:0.3, v:0.5},
  {range:[6,30],  f:0.1,  m:0.2, c:0.5, v:1.0},
  {range:[30,120],f:0.15, m:0.3, c:0.8, v:1.5},
  {range:[120,400],f:0.2, m:0.5, c:1.2, v:2.5},
  {range:[400,1000],f:0.3,m:0.8, c:2.0, v:4.0},
  {range:[1000,2000],f:0.5,m:1.2, c:3.0, v:6.0},
];

// Angular (ISO 2768-1) — tolerance vs. shorter side length L (values as degrees; minutes allowed via "deg + min/60").
// This is a practical set; please verify.
const DATA_ANGULAR = [
  {range:[0,10],   f:{deg:1, min:0},   m:{deg:1, min:0},   c:{deg:1, min:0},   v:{deg:1, min:0}},
  {range:[10,50],  f:{deg:0, min:30},  m:{deg:1, min:0},   c:{deg:1, min:30},  v:{deg:2, min:0}},
  {range:[50,120], f:{deg:0, min:20},  m:{deg:0, min:30},  c:{deg:1, min:0},   v:{deg:1, min:30}},
  {range:[120,400],f:{deg:0, min:10},  m:{deg:0, min:20},  c:{deg:0, min:30},  v:{deg:1, min:0}},
  {range:[400,1000],f:{deg:0, min:5},  m:{deg:0, min:10},  c:{deg:0, min:20},  v:{deg:0, min:30}},
  {range:[1000,2000],f:{deg:0, min:3}, m:{deg:0, min:5},   c:{deg:0, min:10},  v:{deg:0, min:20}},
];

// Chamfers & Radii (ISO 2768-1) — ± tolerance vs feature size (mm). Practical set; verify.
const DATA_CHAMFER = [
  {range:[0,2],    f:0.2, m:0.4, c:0.8, v:1.5},
  {range:[2,6],    f:0.3, m:0.5, c:1.0, v:2.0},
  {range:[6,30],   f:0.5, m:1.0, c:2.0, v:4.0},
  {range:[30,120], f:1.0, m:2.0, c:3.0, v:5.0},
  {range:[120,400],f:2.0, m:3.0, c:4.0, v:6.0},
];

// Geometrical (ISO 2768-2) — generalized practical values (mm) by feature length L and class H/K/L. Verify.
const GEO_LENGTH_RANGES = [
  [0,10],[10,30],[30,100],[100,300],[300,1000]
];
const DATA_GEOM = {
  straightness: { // of a line/surface
    H:[0.02,0.05,0.1,0.2,0.3],
    K:[0.05,0.1,0.2,0.4,0.6],
    L:[0.1,0.2,0.4,0.8,1.2],
  },
  flatness: {
    H:[0.02,0.05,0.1,0.2,0.3],
    K:[0.05,0.1,0.2,0.4,0.6],
    L:[0.1,0.2,0.4,0.8,1.2],
  },
  circularity: { // roundness
    H:[0.02,0.04,0.06,0.08,0.1],
    K:[0.04,0.06,0.08,0.12,0.16],
    L:[0.06,0.1,0.14,0.2,0.3],
  },
  parallelism: {
    H:[0.05,0.08,0.12,0.2,0.3],
    K:[0.1,0.16,0.25,0.4,0.6],
    L:[0.2,0.3,0.5,0.8,1.2],
  },
  perpendicularity: {
    H:[0.05,0.1,0.15,0.25,0.4],
    K:[0.1,0.2,0.3,0.5,0.8],
    L:[0.2,0.4,0.6,1.0,1.6],
  },
  symmetry: {
    H:[0.05,0.08,0.12,0.2,0.3],
    K:[0.1,0.16,0.25,0.4,0.6],
    L:[0.2,0.3,0.5,0.8,1.2],
  },
  runout: { // radial run-out
    H:[0.05,0.08,0.12,0.2,0.3],
    K:[0.1,0.16,0.25,0.4,0.6],
    L:[0.2,0.3,0.5,0.8,1.2],
  }
};

// ------------- Helpers -------------
function $(sel){return document.querySelector(sel)}
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}
function setText(el, txt){el.textContent = txt}

function inRange(x, a, b){ return x > a && x <= b; } // (a, b]

function pickLinear(n, cls){
  for(const row of DATA_LINEAR){
    if(inRange(n, row.range[0], row.range[1])){
      const tol = row[cls];
      return {plus: tol, minus: -tol, total: tol*2};
    }
  }
  return null;
}

function degMinToDecimal(obj){
  return (obj.deg || 0) + (obj.min || 0)/60;
}
function pickAngular(L, cls){
  for(const row of DATA_ANGULAR){
    if(inRange(L, row.range[0], row.range[1])){
      const tolDeg = degMinToDecimal(row[cls]);
      return {plus: tolDeg, minus: -tolDeg, total: tolDeg*2};
    }
  }
  return null;
}

function pickChamfer(s, cls){
  for(const row of DATA_CHAMFER){
    if(inRange(s, row.range[0], row.range[1])){
      const tol = row[cls];
      return {plus: tol, minus: -tol, total: tol*2};
    }
  }
  return null;
}

function pickGeom(L, feature, cls){
  let idx = -1;
  for(let i=0;i<GEO_LENGTH_RANGES.length;i++){
    const [a,b] = GEO_LENGTH_RANGES[i];
    if(inRange(L,a,b)){ idx = i; break; }
  }
  if(idx < 0) return null;
  const arr = DATA_GEOM[feature][cls];
  const tol = arr[idx];
  return {plus: tol, minus: 0, total: tol}; // geometrical tolerance is a limit, not ±
}

function fmtNum(x){ return (Math.round(x*1000)/1000).toString(); }
function fmtAngleDeg(x){
  const sign = x < 0 ? "-" : "";
  x = Math.abs(x);
  const deg = Math.floor(x);
  const min = Math.round((x - deg)*60);
  return `${sign}${deg}° ${min.toString().padStart(2,"0")}'`;
}

// Render result cards
function renderResult(container, data, mode){
  container.innerHTML = "";
  if(!data){
    const p = document.createElement('p');
    p.className = "muted";
    p.dataset.i18n = "not_found";
    p.textContent = I18N[currentLang].not_found;
    container.appendChild(p);
    show(container);
    return;
  }
  const mkCard = (label, val, angle=false)=>{
    const div = document.createElement('div');
    div.className = "card";
    const h = document.createElement('div');
    h.className = "muted";
    h.textContent = label;
    const v = document.createElement('div');
    v.style.fontSize = "20px";
    v.style.fontWeight = "700";
    v.textContent = angle ? fmtAngleDeg(val) : fmtNum(val);
    div.appendChild(h); div.appendChild(v);
    return div;
  };
  const angleMode = (mode === 'angular');
  container.classList.remove('hidden');
  container.appendChild(mkCard(I18N[currentLang].upper, data.plus, angleMode));
  container.appendChild(mkCard(I18N[currentLang].lower, data.minus, angleMode));
  container.appendChild(mkCard(I18N[currentLang].total, data.total, angleMode));
}

// ------------- Language & Theme -------------
let currentLang = "en";
function applyLang(code){
  currentLang = code;
  document.documentElement.lang = code;
  document.body.classList.toggle('rtl', code === 'ar');
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.dataset.i18n;
    if(I18N[code][key]) el.textContent = I18N[code][key];
  });
  document.querySelectorAll(".lang button").forEach(b=>b.classList.toggle("active", b.dataset.lang===code));
  // Update footer theme status text
  updateThemeStatus();
}
document.querySelectorAll(".lang button").forEach(btn=>{
  btn.addEventListener('click', ()=>applyLang(btn.dataset.lang));
});

// Theme handling
const THEME_KEY = "din2768_theme";
function applyTheme(theme){
  document.documentElement.dataset.theme = theme;
  localStorage.setItem(THEME_KEY, theme);
  updateThemeStatus();
}
function updateThemeStatus(){
  const el = document.getElementById('theme-status');
  const theme = document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
  el.textContent = theme === 'light' ? I18N[currentLang].theme_light : I18N[currentLang].theme_dark;
}

document.getElementById('theme-toggle').addEventListener('click', ()=>{
  const curr = document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
  applyTheme(curr === 'light' ? 'dark' : 'light');
});

// Mode switching
const sections = {
  linear: $("#section-linear"),
  angular: $("#section-angular"),
  chamfer: $("#section-chamfer"),
  geom: $("#section-geom"),
};
function switchMode(m){
  Object.entries(sections).forEach(([k,el])=> k===m ? show(el): hide(el));
  document.querySelectorAll('[data-mode]').forEach(b=>{
    b.classList.toggle('primary', b.dataset.mode===m);
  });
}
document.querySelectorAll('[data-mode]').forEach(btn=>{
  btn.addEventListener('click', ()=>switchMode(btn.dataset.mode));
});

// Calc handlers
$("#lin-calc").addEventListener('click', ()=>{
  const n = parseFloat($("#lin-n").value);
  const cls = $("#lin-class").value;
  const out = pickLinear(n, cls);
  renderResult($("#lin-out"), out, 'linear');
});

$("#ang-calc").addEventListener('click', ()=>{
  const L = parseFloat($("#ang-l").value);
  const cls = $("#ang-class").value;
  const out = pickAngular(L, cls);
  renderResult($("#ang-out"), out, 'angular');
});

$("#chf-calc").addEventListener('click', ()=>{
  const s = parseFloat($("#chf-s").value);
  const cls = $("#chf-class").value;
  const out = pickChamfer(s, cls);
  renderResult($("#chf-out"), out, 'chamfer');
});

$("#geo-calc").addEventListener('click', ()=>{
  const L = parseFloat($("#geo-l").value);
  const feature = $("#geo-feature").value;
  const cls = $("#geo-class").value;
  const out = pickGeom(L, feature, cls);
  renderResult($("#geo-out"), out, 'geom');
});

// Data view
function renderData(){
  const el = $("#data-view");
  const makeTable = (head, rows)=>{
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    head.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); table.appendChild(thead);
    const tbody = document.createElement('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    return table;
  };
  el.innerHTML = "";

  // Linear
  el.appendChild(document.createElement('hr'));
  el.appendChild(Object.assign(document.createElement('h4'), {textContent: "Linear (± mm)"}));
  el.appendChild(makeTable(["Range (mm)","f","m","c","v"],
    DATA_LINEAR.map(r=>[`${r.range[0]}–${r.range[1]}`, r.f, r.m, r.c, r.v])));

  // Angular
  el.appendChild(document.createElement('hr'));
  el.appendChild(Object.assign(document.createElement('h4'), {textContent: "Angular (± in degrees) by shorter side L"}));
  el.appendChild(makeTable(["L range (mm)","f","m","c","v"],
    DATA_ANGULAR.map(r=>[
      `${r.range[0]}–${r.range[1]}`,
      fmtAngleDeg(degMinToDecimal(r.f)),
      fmtAngleDeg(degMinToDecimal(r.m)),
      fmtAngleDeg(degMinToDecimal(r.c)),
      fmtAngleDeg(degMinToDecimal(r.v)),
    ])));

  // Chamfer
  el.appendChild(document.createElement('hr'));
  el.appendChild(Object.assign(document.createElement('h4'), {textContent: "Chamfers & Radii (± mm)"}));
  el.appendChild(makeTable(["Size range (mm)","f","m","c","v"],
    DATA_CHAMFER.map(r=>[`${r.range[0]}–${r.range[1]}`, r.f, r.m, r.c, r.v])));

  // Geometrical
  el.appendChild(document.createElement('hr'));
  el.appendChild(Object.assign(document.createElement('h4'), {textContent: "Geometrical (mm) by length L"}));
  const heads = ["Range (mm)","H","K","L"];
  function rowsFor(feature){
    return GEO_LENGTH_RANGES.map((rng,i)=>[`${rng[0]}–${rng[1]}`, DATA_GEOM[feature].H[i], DATA_GEOM[feature].K[i], DATA_GEOM[feature].L[i]]);
  }
  ["straightness","flatness","circularity","parallelism","perpendicularity","symmetry","runout"].forEach(feat=>{
    el.appendChild(Object.assign(document.createElement('h5'), {textContent: feat}));
    el.appendChild(makeTable(heads, rowsFor(feat)));
  });
}

function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const initial = (saved === 'light' || saved === 'dark') ? saved : 'dark';
  document.documentElement.dataset.theme = initial;
  updateThemeStatus();
}

renderData();
applyLang('en');
switchMode('linear');
initTheme();
</script>
</body>
</html>
